<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Player Ratings</title>
    <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f4f6fa; color: #222; height: 100vh; min-height: 100vh; }
    h1 { color: #2a3a5e; }
    .container { max-width: 100vw; min-height: 100vh; margin: 0; background: #fff; border-radius: 0; box-shadow: none; padding: 2em 4vw; }
    .controls { display: flex; flex-wrap: wrap; gap: 1em; align-items: center; margin-bottom: 2em; }
    .controls input, .controls select { padding: 0.3em 0.6em; border-radius: 4px; border: 1px solid #bbb; }
    button { background: #2a3a5e; color: #fff; border: none; border-radius: 4px; padding: 0.5em 1.2em; font-size: 1em; cursor: pointer; transition: background 0.2s; }
    button:hover { background: #1d2740; }
    #output { margin-top: 2em; width: 100vw; min-height: 60vh; }
    .chart-block { margin-bottom: 2em; background: #f8f8f8; border-radius: 10px; padding: 1em; box-shadow: 0 2px 8px #0001; max-width: 700px; margin-left: auto; margin-right: auto; }
    .chart-title { font-size: 1.1em; margin-bottom: 0.5em; color: #2a3a5e; }
    .error { color: #c00; margin-top: 1em; }
    table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    th, td { border: 1px solid #e0e0e0; padding: 0.5em 0.7em; text-align: left; }
    th { background: #f0f3fa; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2em; margin-top: 2em; }
    </style>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Chess Player Ratings</h1>
        <div class="controls">
            <label>Top <input id="topN" type="number" min="1" max="50" value="10" style="width:4em"></label>
            <label>Type
                <select id="type">
                    <option value="classical">Classical</option>
                    <option value="blitz">Blitz</option>
                    <option value="rapid">Rapid</option>
                </select>
            </label>
            <label>Days <input id="days" type="number" min="1" max="365" value="30" style="width:4em"></label>
            <button id="loadBtn">Load Top Players</button>
            <button id="csvBtn">Download CSV</button>
        </div>
        <div id="output"></div>
    </div>
    <script>
    const out = document.getElementById('output');
    const topN = document.getElementById('topN');
    const type = document.getElementById('type');
    const days = document.getElementById('days');
    const loadBtn = document.getElementById('loadBtn');
    const csvBtn = document.getElementById('csvBtn');
    let lastPlayers = [];
    let lastRatings = [];
    function showError(msg) {
        out.innerHTML = `<div class="error">${msg}</div>`;
    }
    async function fetchPlayers() {
        out.innerHTML = 'Loading...';
        try {
            const resp = await fetch(`/players?top=${topN.value}&type=${type.value}`);
            if (!resp.ok) throw new Error('Failed to fetch players');
            const data = await resp.json();
            lastPlayers = data;
            out.innerHTML = `<table><thead><tr><th>#</th><th>Username</th></tr></thead><tbody>` +
                data.map((u, i) => `<tr><td>${i+1}</td><td><a href="#" class="username-link" data-username="${u}">${u}</a></td></tr>`).join('') +
                `</tbody></table>`;
            document.querySelectorAll('.username-link').forEach(link => {
                link.addEventListener('click', async e => {
                    e.preventDefault();
                    await showPlayerChart(link.dataset.username);
                });
            });
        } catch (e) {
            showError(e.message);
        }
    }
    async function showPlayerChart(username) {
        out.innerHTML = 'Loading...';
        try {
            const resp = await fetch(`/players/${username}/ratings?type=${type.value}&days=${days.value}`);
            if (!resp.ok) throw new Error('Failed to fetch rating history');
            const data = await resp.json();
            out.innerHTML = `<div class="chart-block"><div class="chart-title">${username} (${type.value})</div><div id="chart"></div></div>`;
            const x = Object.keys(data.ratings);
            const y = Object.values(data.ratings);
            Plotly.newPlot('chart', [{x, y, type:'scatter', mode:'lines+markers', line:{shape:'spline', color:'#2a3a5e'}}], {
                margin: {t:30, l:40, r:10, b:40},
                plot_bgcolor: '#f8f8f8',
                paper_bgcolor: '#f8f8f8',
                xaxis: {title: 'Date'},
                yaxis: {title: 'Rating'},
            }, {displayModeBar: false});
        } catch (e) {
            showError(e.message);
        }
    }
    async function fetchRatingsGrid() {
        out.innerHTML = 'Loading...';
        try {
            const resp = await fetch(`/players/ratings?top=${topN.value}&type=${type.value}&days=${days.value}`);
            if (!resp.ok) throw new Error('Failed to fetch ratings');
            const data = await resp.json();
            lastRatings = data;
            let players = Array.isArray(data) ? data : [data];
            out.innerHTML = `<div class="grid"></div>`;
            const grid = document.querySelector('.grid');
            const colors = [
                '#2a3a5e', '#e4572e', '#17bebb', '#ffc914', '#76b041',
                '#6a4c93', '#f45b69', '#4e8098', '#e2b534', '#3dccc7'
            ];
            players.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'chart-block';
                div.innerHTML = `<div class="chart-title">${p.username}</div><div id="chart${i}"></div>`;
                grid.appendChild(div);
                const x = Object.keys(p.ratings);
                const y = Object.values(p.ratings);
                Plotly.newPlot(`chart${i}`, [{x, y, type:'scatter', mode:'lines+markers', line:{shape:'spline', color:colors[i%colors.length]}}], {
                    margin: {t:30, l:40, r:10, b:40},
                    plot_bgcolor: '#f8f8f8',
                    paper_bgcolor: '#f8f8f8',
                    xaxis: {title: 'Date'},
                    yaxis: {title: 'Rating'},
                }, {displayModeBar: false});
            });
        } catch (e) {
            showError(e.message);
        }
    }
    loadBtn.onclick = fetchPlayers;
    csvBtn.onclick = () => {
        window.location = `/players/ratings/csv?top=${topN.value}&type=${type.value}&days=${days.value}`;
    };
    fetchPlayers();
    </script>
</body>
</html> 